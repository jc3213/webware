<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Messaging Sample - Download with Aria2</title>
    <link rel="stylesheet" href="chromium/pages/common.css">
    <style>
body {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    margin: auto;
    width: 300px;
    height: 80vh;
    gap: 3px;
}

button {
    padding: 10px 40px;
    font-size: 20px;
    cursor: pointer;
}

textarea {
    width: 600px;
    height: 300px;
    resize: none;
    font-size: 20px;
}
</style>
</head>
<body>
    <button>Run</button>
    <textarea disabled></textarea>
    <script>
(() => {
    const callMap = new Map();

    window.aria2Call = function (aria2c, params) {
        return new Promise((resolve, reject) => {
            let id = crypto.randomUUID();
            let timer = setTimeout(() => {
                callMap.delete(id);
                reject( new Error('"Download With Aria2" is either not installed, disabled, or outdated (must be higher than v4.16.4.3450).') );
            }, 3000);
            callMap.set(id, (result) => {
                clearTimeout(timer);
                callMap.delete(id);
                resolve(result);
            });
            window.postMessage({ aria2c, id, params });
        });
    };

    const handler = {
        'aria2c_response': (id, result) => callMap.get(id)(result)
    };

    window.addEventListener('message', (event) => {
        let { aria2c, id, result } = event.data
        handler[aria2c]?.(id, result);
    });
})();

let [testBtn, testResult] = document.body.children;

function aria2Echo() {
    return new Promise((resolve, reject) => {
        let connect = (event) => {
            let { aria2c, name, version } = event.data;
            if (aria2c === 'aria2c_response_echo') {
                clearTimeout(timer);
                window.removeEventListener('message', connect);
                resolve( { name, version } );
            }
        };
        let timer = setTimeout(() => {
            window.removeEventListener('message', connect);
            reject( new Error('"Download With Aria2" is either not installed, disabled, or outdated (must be v4.15.4.3371 or higher).') );
        }, 5000);
        window.addEventListener('message', connect);
        window.postMessage({ aria2c: 'aria2c_jsonrpc_echo' });
    });
}

function startTest() {
    testResult.value = 'Evaluating if "Download With Aria2" is within v4.15.4.3371 to v4.16.4.3450';
    aria2Echo().then(onSuccess).catch((err) => {
        testResult.value = 'Evaluating if "Download With Aria2" is higher than 'v4.16.4.3450';
        aria2Call('aria2c_manifest').then(onSuccess).catch(onFailure);
    });
}

function onSuccess({ name, version }) {
    testResult.value = 'Extension Name: ' +name + '\nVersion: ' + version;
}

function onFailure(error) {
    testResult.value = error;
}

testBtn.addEventListener('click', startTest);

startTest();
    </script>
</body>
</html>
